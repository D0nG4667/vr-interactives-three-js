<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Building VR interactives with Three.js</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <style>
    html, body {margin:0; padding:0;}
    </style>
</head>
<body>
    <!-- Our scene will go here -->
    <div id="webgl"></div>

    <!-- Assets we'll need - Three.js, controls, and the webVR manager and polyfill -->
    <script src="js/three-r73.js"></script>
    <script src="js/three.flycontrols.js"></script>
    <script src="js/three.terrainloader.js"></script>
    <script src="js/webvr-manager.js"></script>
    <script src="js/webvr-polyfill.js"></script>
    <script src="js/VRControls.js"></script>
    <script src="js/VREffect.js"></script>

    <script>
    // Constants
    var WINDOW_WIDTH = window.innerWidth,
        WINDOW_HEIGHT = window.innerHeight,
        WORLD_WIDTH = 2000,
        WORLD_HEIGHT = 1900;

    // Create the "scene" and camera
    var container = document.getElementById("webgl"),   // containing element
        scene = new THREE.Scene(),
        camera = new THREE.PerspectiveCamera(75, WINDOW_WIDTH / WINDOW_HEIGHT, 1, 5000);

    camera.position.set(0, -199, 75);
    camera.up = new THREE.Vector3(0,0,1);
    camera.lookAt(scene.position);

    // Create and append the renderer
    var renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setClearColor(0xffd4a6);
    renderer.setSize(WINDOW_WIDTH, WINDOW_HEIGHT);
    container.appendChild( renderer.domElement );

    // Apply VR stereo rendering to renderer
    var effect = new THREE.VREffect(renderer);
    effect.setSize(WINDOW_WIDTH, WINDOW_HEIGHT);

    // Create a VR manager helper to enter and exit VR mode
    var manager = new WebVRManager(renderer, effect);

    // Set the URL for the terrain data and initialize the loader
    var terrainURL = "data/Gale_HRSC_DEM_50m_300x285.bin";
    var terrainLoader = new THREE.TerrainLoader();
    var surface;

    // The terrainLoader loads the DEM file and defines a function to be called when the file is successfully downloaded.
    terrainLoader.load(terrainURL, function(data){
        // Create the plane geometry
        var geometry = new THREE.PlaneGeometry(WORLD_WIDTH, WORLD_HEIGHT, 299, 284);

        // Adjust each vertex in the plane to correspond to the height value in the DEM file.
        for (var i = 0, l = geometry.vertices.length; i < l; i++) {
            geometry.vertices[i].z = data[i] / 65535 * 100;
        }

        var textureLoader = new THREE.TextureLoader()
        var textureURL = "data/Gale_texture_high_4096px.jpg";

        textureLoader.load(textureURL, function(texture) {
            var material = new THREE.MeshLambertMaterial({
                color: 0xffffff,
                map: texture
            });

            surface = new THREE.Mesh(geometry, material);
            scene.add(surface);
        });


    });



    // Lights!
    var dirLight = new THREE.DirectionalLight( 0xffffff, 0.75);
    dirLight.position.set( -1, 1, 1).normalize();

    var ambiLight = new THREE.AmbientLight(0x999999);

    scene.add(ambiLight);
    scene.add(dirLight);

    var controls = new THREE.FlyControls(camera);
    controls.autoForward = false;

    // Render loop
    function render() {
        // Render the scene through the manager.
        requestAnimationFrame( render );
        manager.render(scene, camera);
    }

    render();

    </script>

</body>
</html>